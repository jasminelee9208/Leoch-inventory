<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Leoch Inventory</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 5px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      height: 70px;
    }

    .header h2 {
      margin: 0;
      font-size: 32px
    }
    
    #lastUpdated {
      color: #666;
      margin-bottom: 15px;
    }

    .filters {
      margin-bottom: 15px;
    }

    input, select {
      padding: 5px;
      font-size: 14px;
      margin-right: 5px;
    }

    table {
      border-collapse: collapse;
      width: 80%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #f2f2f2;
    }

    tr.hidden {
      display: none;
    }
  </style>
</head>

<body>

<!-- Header with Logo -->
<div class="header">
  <img src="logo.png" alt="Leoch Logo" class="logo">
  <h2>Leoch Inventory</h2>
</div>
  
<p id="lastUpdated"></p>

<div class="filters">
<!-- Search box -->
  <input
    type="text"
    id="search"
    placeholder="Search by part number..."
    onkeyup="applyFilters()"
  >

<!-- Location dropdown -->
  <select id="locationFilter" onchange="applyFilters()">
    <option value="">All Locations</option>
  </select>
</div>

<table id="inventoryTable">
  <thead>
    <tr>
      <th>Material</th>
      <th>Part Number</th>
      <th>Location</th>
      <th>Available Qty</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const locations = new Set();

/* ================================
   CSV PARSER
================================ */
function parseCSVLine(line) {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }

  result.push(current);
  return result.map(v => v.trim());
}

/* ================================
   NORMALIZE PART NUMBER
   (removes terminals like (T8))
================================ */
function normalizePart(part) {
  if (!part) return "";
  return part
    .toUpperCase()
    .replace(/\(.*?\)/g, "")   // remove anything in ()
    .replace(/\s+/g, "")       // remove spaces
    .trim();
}

/* ================================
   EXTRACT VOLTAGE
   Works for LP6-..., LP12-..., LDC8-..., etc.
================================ */
function extractVoltage(part) {
  const clean = normalizePart(part);

  const match = clean.match(/[A-Z]+(\d+)-/);
  if (match) return parseFloat(match[1]);

  return 0;
}

/* ================================
   GROUP ORDER (MATCHES YOUR PDF)
================================ */
function getGroupPriority(part) {
  const clean = normalizePart(part);

  if (clean.startsWith("LP") || clean.startsWith("LPL")) return 1;       // General Purpose
  if (clean.startsWith("LDC")) return 2;                                 // Deep Cycle AGM
  if (clean.startsWith("LPX") || clean.startsWith("XP") || clean.startsWith("HXP")) return 3; // High Rate UPS
  if (clean.startsWith("PLC")) return 4;                                 // Pure Lead + Carbon
  if (clean.startsWith("LPF")) return 5;                                 // AGM Front Terminal
  if (clean.startsWith("PLH")) return 6;                                 // Pure Lead Long Life
  if (clean.startsWith("PLF")) return 7;                                 // Pure Lead Motive
  if (clean.startsWith("DT")) return 8;                                   // Flooded Deep Cycle
  if (clean.startsWith("AGM-")) return 9;                                // Automotive AGM
  if (clean.startsWith("PLS")) return 10;                                // Marine
  if (clean.match(/^(MX|LMX|EB|LBX|LB)/)) return 11;                     // Power Sports

  return 99; // Anything unknown goes last
}

/* ================================
   LOAD CSV
================================ */
fetch("Inventory.csv")
  .then(res => res.text())
  .then(text => {

    const lines = text
      .split("\n")
      .map(l => l.trim())
      .filter(l => l.length);

    /* ----- Extract Date ----- */
    const dateLine = lines.find(l => l.includes("Inventory List"));
    if (dateLine) {
      const dateMatch = dateLine.match(/(\d{2}\/\d{2}\/\d{4})/);
      if (dateMatch) {
        document.getElementById("lastUpdated").innerText =
          "Last updated: " + dateMatch[1];
      }
    }

    /* ----- Find Header Row ----- */
    const headerIndex = lines.findIndex(l => l.includes("Material"));
    if (headerIndex === -1) return;

    let headers = parseCSVLine(lines[headerIndex]);
    while (headers[0] === "") headers.shift();

    const materialIdx = headers.indexOf("Material");
    const partIdx     = headers.indexOf("Leoch Part Number");
    const locationIdx = headers.indexOf("Sto.Loction");
    const qtyIdx      = headers.indexOf("Qty.Avail");

    let inventoryData = [];

    /* ----- Parse Data Rows ----- */
    lines.slice(headerIndex + 1).forEach(line => {

      let cols = parseCSVLine(line);
      while (cols.length && cols[0] === "") cols.shift();

      const material = cols[materialIdx];
      const part     = cols[partIdx];
      const location = cols[locationIdx];

      let qty = cols[qtyIdx]
        ?.replace(/"/g, "")
        .replace(/,/g, "");

      qty = parseFloat(qty);

      if (!Number.isFinite(qty) || qty <= 0) return;

      const voltage = extractVoltage(part);
      const groupPriority = getGroupPriority(part);

      inventoryData.push({
        material,
        part,
        location,
        qty,
        voltage,
        groupPriority
      });

      locations.add(location);
    });

    /* ================================
       SORTING (PDF STYLE)
       1. Group
       2. Voltage Low â†’ High
       3. Part Number
    ================================= */
    inventoryData.sort((a, b) => {

      if (a.groupPriority !== b.groupPriority) {
        return a.groupPriority - b.groupPriority;
      }

      if (a.voltage !== b.voltage) {
        return a.voltage - b.voltage;
      }

      return normalizePart(a.part).localeCompare(normalizePart(b.part));
    });

    /* ----- Render Table ----- */
    const tbody = document.querySelector("#inventoryTable tbody");
    tbody.innerHTML = "";

    inventoryData.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.material}</td>
        <td>${item.part}</td>
        <td>${item.location}</td>
        <td>${item.qty.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });

    populateLocationDropdown();
  });

/* ================================
   LOCATION DROPDOWN
================================ */
function populateLocationDropdown() {
  const select = document.getElementById("locationFilter");
  select.innerHTML = `<option value="">All Locations</option>`;

  Array.from(locations)
    .sort()
    .forEach(loc => {
      const opt = document.createElement("option");
      opt.value = loc;
      opt.textContent = loc;
      select.appendChild(opt);
    });
}

/* ================================
   SEARCH + FILTER
================================ */
function applyFilters() {
  const search = document.getElementById("search").value.toUpperCase();
  const loc    = document.getElementById("locationFilter").value;

  document.querySelectorAll("#inventoryTable tbody tr")
    .forEach(row => {
      const part = row.cells[1].innerText.toUpperCase();
      const rowLoc = row.cells[2].innerText;

      const show =
        part.includes(search) &&
        (!loc || rowLoc === loc);

      row.classList.toggle("hidden", !show);
    });
}
</script>



</body>
</html>
